<%= form_for @shipment do |f| %>
<% if @shipment.errors.any? %>
	<div id="error_explanation">
	  <h2>
	    <%= pluralize(@shipment.errors.count, "error") %> prohibited
	    this shipment from being saved:
	  </h2>
	  <ul>
	    <% @shipment.errors.full_messages.each do |msg| %>
	      <li><%= msg %></li>
	    <% end %>
	  </ul>
	</div>
<% end %>
<div class='panel panel-default'>
	<div class='panel-heading'>Product</div>
	<div class='panel-body'>
		<table class='table table-striped'>
			<thead>
				<tr>
	 				<th>Product</th>
	 				<th>Parcelshop id (if applicable)</th>
	 				<th>Return service (if applicable)</th>
	 				<th>Label action</th>
	 			</tr>
			</thead>
 			<tbody>
 				<tr>
	 				<td>
	 					<%= f.bssel :product_id, options_from_collection_for_select(@current_user.products, :id, :name, :selected => @shipment.product_id) %>
	 				</td>
	 				<td>
	 					<%= f.bstxt_field :parcelshop_id %>
	 				</td>
	 				<td>
	 					<%= f.bssel :return, options_for_select( [['No', 0], ['Yes', 1]], :selected => (@shipment.return ? 1 : 0) ) %>
	 				</td>
	 				<td>
	 					<%= f.bssel :label_action, Shipment.label_action_options %>
	 				</td>
	 			</tr>
 			</tbody>
		</table>
		<table class='table table-striped'>
			<thead>
				<tr>
	 				<th>Delivery instructions</th>
	 				<th>Remarks</th>
	 				<th>Content Description</th>
	 				<th>Reference</th>
	 			</tr>
			</thead>
 			<tbody>
 				<tr>
	 				<td>
	 					<%= f.bstxt_field :delivery_instructions %>
	 				</td>
	 				<td>
	 					<%= f.bstxt_field :remarks %>
	 				</td>
	 				<td>
	 					<%= f.bstxt_field :description %>
	 				</td>
	 				<td>
	 					<%= f.bstxt_field :reference %>
	 				</td>
	 			</tr>
 			</tbody>
 		</table>
	</div>
</div>

<div class='panel panel-default'>
	<div class='panel-heading'>
		Packages
	</div>
	<div class='panel-body'>
		<table class='table table-striped' id='package-table'>
			<thead>
				<tr>
					<th>Length (cm)</th>
					<th>Width (cm)</th>
					<th>Height (cm)</th>
					<th>Weight (kg)</th>
					<th>Amount</th>
				</tr>
			</thead>
			<tbody>
				<% i_package = 0 %>
				<%= f.fields_for :packages do |fp| %>
				<% i_package += 1 %>
				<tr id='package-row-<%= i_package %>'>
					<td>
						<%= fp.bsnum_field :length %>
					</td>
					<td>
						<%= fp.bsnum_field :width %>
					</td>
					<td>
						<%= fp.bsnum_field :height %>
					</td>
					<td>
						<%= fp.bsnum_field :weight, :step => 'any' %>
					</td>
					<td>
						<%= fp.bsnum_field :amount %>
					</td>
				</tr>
				<% end %>
			</tbody>
		<tfoot>
			<tr>
				<td></td>
				<td></td>
				<td></td>
				<td><button id='btn-remove-package' <%= 'disabled' if i_package < 2 %> onclick='removePackage()' type='button' class='btn btn-primary btn-block'>Remove Package</button></td>
				<td><button onclick='addPackage()' type='button' class='btn btn-primary btn-block'>Add Package</button></td>	
			</tr>
		</tfoot>
		</table>
	</div>
</div>

<div class='panel panel-default'>
	<div class='panel-heading'>Addresses</div>
	<div class='panel-body'>
		<div class='col-lg-6'>
			<%= render :partial => 'address_form', :locals => {:prefix => 'sender', :address => (form_address @shipment, 'sender')} %>	
		</div>
		<div class='col-lg-6'>
			<%= render :partial => 'address_form', :locals => {:prefix => 'recipient', :address => (form_address @shipment, 'recipient')} %>
		</div>		
	</div>
</div>




<button class="btn btn-lg btn-primary btn-block" type="submit">Submit</button>

<script type='text/javascript'>
	var nPackages = <%= i_package %>;
	function addPackage(){
		var baseRow = $('#package-row-1');
		nPackages++;
		var html = baseRow.html().replace(new RegExp('\\[0\\]', 'g'), '[' + nPackages + ']')
				.replace(new RegExp('_0_', 'g'), '_' + nPackages + '_');
		var newRow = document.createElement('tr')
		newRow.id = 'package-row-' + nPackages;
		newRow.innerHTML = html;
		$('#package-table').append(newRow);
		$('#btn-remove-package').prop('disabled', false);
	}
	
	function removePackage(){
		if(nPackages < 2){
			return false;
		}
		var lastRow = $('#package-row-' + nPackages);
		lastRow.remove();
		nPackages--;
		if(nPackages < 2){
			$('#btn-remove-package').prop('disabled', true);
		}
		return true;
	}
	
	<%
	default_values = {}
	current_user.user_products.each do |user_product|
		default_values[user_product.product_id] = {
				:country => user_product.default_country,
				:length => user_product.default_length,
				:width => user_product.default_width,
				:height => user_product.default_height,
				:weight => user_product.default_weight
			 }
	end
	%>
	var DEFAULT_VALUES = JSON.parse('<%= default_values.to_json.html_safe %>');

	function setDestinationCountry(productId){
		targetCountry = DEFAULT_VALUES[productId]['country'];
		if(targetCountry == "") return;
		
		$('#recipient_country_code').children().filter(function() {
			return this.value == targetCountry; 
		}).attr('selected', true);
	}
	
	function setPackageDimensions(productId){
		while(removePackage());
		$('#shipment_packages_attributes_0_length').val(DEFAULT_VALUES[productId]['length']);
		$('#shipment_packages_attributes_0_width').val(DEFAULT_VALUES[productId]['width']);
		$('#shipment_packages_attributes_0_height').val(DEFAULT_VALUES[productId]['height']);
		$('#shipment_packages_attributes_0_weight').val(DEFAULT_VALUES[productId]['weight']);
	}
	
	$('#shipment_product_id').on('change', function(){		
		setDestinationCountry(this.value);
		setPackageDimensions(this.value);
	});
	
	$(document).ready(function(){
		destCountrySelector = $('#recipient_country_code');
		if(destCountrySelector.val() == ""){ //Only set default values if this is a new shipment
			setDestinationCountry($('#shipment_product_id').val());
			setPackageDimensions($('#shipment_product_id').val());
		}
	});
	
</script>
<% end %>



